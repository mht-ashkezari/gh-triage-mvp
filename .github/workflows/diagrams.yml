name: Build Architecture Diagrams

on:
  push:
    paths:
      - "docs/arch/releases/**/*.mmd"
      - "tooling/render_diagrams.sh"
      - "tooling/check_component_ids.ts"
      - ".github/workflows/diagrams.yml"
  pull_request:
    paths:
      - "docs/arch/releases/**/*.mmd"
      - "tooling/render_diagrams.sh"
      - "tooling/check_component_ids.ts"
      - ".github/workflows/diagrams.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-diagrams:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - uses: actions/checkout@v4

      # Install minimal OS deps for headless Chromium
      - name: Install system deps for headless Chromium
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 libnspr4 libxss1 libatk1.0-0 libatk-bridge2.0-0 \
            libdrm2 libgbm1 libxshmfence1 libxcomposite1 libxrandr2 \
            libxdamage1 libxfixes3 libxext6 libpango-1.0-0 libcairo2 \
            libgtk-3-0 fonts-liberation libx11-xcb1 libnss3-tools \
            libdbus-glib-1-2 || true
          # Handle Ubuntu 22.04 vs 24.04 difference
          sudo apt-get install -y libasound2 || sudo apt-get install -y libasound2t64
          fc-cache -fv || true

      # Node setup with pnpm cache (fixes "cache: none" error)
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.0
          cache: pnpm

      - name: Enable Corepack and pnpm
        run: |
          set -euo pipefail
          corepack enable
          corepack prepare pnpm@9.12.3 --activate
          echo "$(corepack which pnpm | xargs dirname)" >> $GITHUB_PATH
          pnpm -v

      # Restore pnpm cache
      - name: Determine pnpm store path
        run: echo "STORE_PATH=$(pnpm store path)" >> "$GITHUB_ENV"

      - name: Restore pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # Restore cached Chromium if available
      - name: Restore Chromium cache
        uses: actions/cache/restore@v4
        with:
          path: chrome
          key: ${{ runner.os }}-chrome-${{ hashFiles('.github/workflows/diagrams.yml') }}
          restore-keys: |
            ${{ runner.os }}-chrome-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Install Chromium for Mermaid CLI rendering
      - name: Install Chromium for mermaid-cli
        run: |
          set -euo pipefail
          pnpm dlx @puppeteer/browsers install chrome@stable --base=chrome
          CHROME_PATH="$(pnpm dlx @puppeteer/browsers executable-path chrome@stable --base=chrome || true)"
          if [ -z "${CHROME_PATH}" ]; then
            CHROME_PATH="$(ls -d "$GITHUB_WORKSPACE"/chrome/linux-*/chrome-linux*/chrome 2>/dev/null | head -n1 || true)"
          fi
          if [ -z "${CHROME_PATH}" ] || [ ! -x "${CHROME_PATH}" ]; then
            echo "❌ Failed to resolve Chromium executable path." >&2
            exit 1
          fi
          echo "PUPPETEER_EXECUTABLE_PATH=${CHROME_PATH}" >> "$GITHUB_ENV"
          echo "Using Chromium: ${CHROME_PATH}"

      - name: Save Chromium cache
        if: ${{ !cancelled() }}
        uses: actions/cache/save@v4
        with:
          path: chrome
          key: ${{ runner.os }}-chrome-${{ hashFiles('.github/workflows/diagrams.yml') }}

      # Render all versioned diagrams and check IDs
      - name: Render versioned diagrams
        run: pnpm diagrams:build

      - name: Run component ID consistency check
        run: pnpm diagrams:check

      # Upload as artifact
      - name: Set safe artifact name
        run: |
          SAFE_BRANCH="${GITHUB_REF_NAME//\//-}"
          echo "ART_NAME=arch-diagrams-${SAFE_BRANCH:-${GITHUB_SHA}}" >> "$GITHUB_ENV"

      - name: Upload diagrams artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ART_NAME }}
          path: docs/img/
          if-no-files-found: error
          compression-level: 6
